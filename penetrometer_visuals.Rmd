---
title: "Penetrometer"
author: "Rebecca Martinez"
date: "11-18-2025"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,     # hide code
  warning = FALSE,  # hide warnings
  message = FALSE,  # hide messages
  error = FALSE     # hide errors
)

#install.packages("tidyverse")
#install.packages("gt")
#install.packages("flextable")
#intall.packages("janitor")
#install.packages("cowplot")
library(tidyverse)
library(janitor) #clean data 
library(gt)
library(flextable)
library(cowplot) # plots into objects, insert objects to make grid


```

```{r data}
penetrometer_raw <- read_csv("data_raw/wide_penetrometer.csv") 

penetrometer_clean <- clean_names(penetrometer_raw) |> 
  select(-pd_blows_m, -notes, -average_number_blows, -face_distance_m)

```

## Methods and Measurments


The drop cone method measures the depth of penetration resulting from a cone of fixed mass being dropped from a standard height. The hammer-type penetrometers use a slide hammer of fixed mass and drop height to apply consistent kinetic energy with each blow. Either the number of blows required to penetrate a specified depth, or the depth of penetration per blow are measured in this method.

Soil penetration resistance \(R_s\) is defined as the work done by the soil divided by the distance the penetrometer travels:

\[
R_s = \frac{W_s}{P_d}
\]

where \(R_s\) is the soil resistance (N), \(W_s\) is the work done by the soil (J), and \(P_d\) is the distance the penetrometer travels (m).


The kinetic energy of a hammer of mass \(m = 4.58 \text{ kg}\) falling a distance \(x = 0.45 \text{ m}\) is:

\[
v = \sqrt{v_0^2 + 2 a x} = \sqrt{0 + 2 (9.8)(0.45)} = 2.97 \text{ m/s}
\]

\[
KE = \frac{1}{2} m v^2 = \frac{1}{2} (4.58)(2.97)^2 = 20.20 \text{ J}
\]



Then the soil resistance is calculated as:

\[
R_s = \frac{W_s}{P_d} = \frac{KE}{P_d}
\]


\[
P_d = \frac{blows}{m} = \frac{0.10m}{blows}
\]

So: 

\[
R_s = \frac{W_s}{P_d} = \frac{0.10}{blows} = \frac{\mult{W_s}{0.10}}{blows}
\]



```{r}
# long format
# chaned cm to m
pen_clean <- penetrometer_clean |>
  rename_with(
    ~ str_replace(.x, "blows_(\\d+)_cm", function(m) {
      num <- as.numeric(sub("blows_(\\d+)_cm", "\\1", m))
      paste0(num/100, "_m")
    }),
    starts_with("blows_")
  )

pen_long <- pen_clean |>
  pivot_longer(
    cols = ends_with("_m"),
    names_to = "depth_m",
    values_to = "blows"
  )
# rename pit to pen for penetrometer sample at each pit
clean_pen <- pen_long |> 
  mutate(
    pen = pit,
    depth_m = str_remove(depth_m, "_m"),   # remove the text
  ) |> 
  select(-total_blows) 

# create a pit groups  
clean_data <- clean_pen |>
  mutate(
    pit = case_when(
      str_detect(pen, "CP1") ~ "CP1",
      str_detect(pen, "tau") ~ "tau",
      str_detect(pen, "gusty") ~ "gusty",
      TRUE ~ "other"
    ),
      pit = recode(
      pit,
      "CP1"   = "WML",
      "tau"   = "TAU",
      "gusty" = "GDS"
    )
  )


```

```{r resistance calculation}

# Add Pd and Rs
resistance <- clean_data |>
  mutate(
    Pd = 0.10/ blows,      # blows per meter  
    Rs = 20.20 / Pd      # work per depth increment
  )

# Rs summary per pit × depth × location
rs_summary <- resistance |>
  mutate(depth_m = as.numeric(depth_m)) |>      # convert depth to numeric
  group_by(pit, depth_m) |>
  summarise(
    avg_Rs = mean(Rs, na.rm = TRUE),
    min_Rs = min(Rs, na.rm = TRUE),
    max_Rs = max(Rs, na.rm = TRUE),
    .groups = "drop"
  ) |> 
  left_join(
    resistance |> select(pit, location) |> distinct(),
    by = "pit"
  )

```


```{r pit colors}

pit_colors <- c(
  "WML"   = "darkred",
  "TAU"   = "gold4",
  "GDS" = "darkgreen"
)


```



```{r first Rs plot}

ggplot(rs_summary,
       aes(x = avg_Rs, y = depth_m, group = location, color = location)) +
  
  # --- RIBBON: min_Rs → max_Rs ---
  geom_ribbon(
    aes(
      xmin = min_Rs,
      xmax = max_Rs,
      fill = location
    ),
    alpha = 0.45,
    color = NA
  ) +
  
  # --- MEAN Rs LINE ---
  geom_path(linewidth = 1.2, alpha = 0.9) +
  
   # --- DEPTH GOES DOWNWARD ---
  scale_y_reverse() +
  
   labs(
    x = "Soil Resistance (N)",
    y = "Depth (m)"
  ) +
  
  theme_minimal(base_size = 12) +
  theme(
    panel.background = element_rect(color = "black"),
    strip.background = element_rect(color = "black"),
    strip.text = element_text(face = "bold", size = 13),
    axis.text.x = element_text(angle = 45, hjust = 1),

  )



```



```{r}
#disturbance df 

disturbance <- pen_clean |> 
  rename(group = pit,
         Pd = total_blows) |> 
  mutate(pit = case_when(
      str_detect(group, "CP1") ~ "CP1",
      str_detect(group, "tau") ~ "tau",
      str_detect(group, "gusty") ~ "gusty",
      TRUE ~ "other"
    ),
      pit = recode(
      pit,
      "CP1"   = "WML",
      "tau"   = "TAU",
      "gusty" = "GDS"
    ),
    Rs = 20.20 * Pd 
  ) |> 
  select(location, pit, group, disturbances, Rs) 


# disturbance with Rs calculations

ggplot(disturbance, aes(x = pit, y = disturbances, fill = pit)) +
  geom_boxplot(alpha = 0.60) +
  labs(y = "Disturbances") +
  facet_wrap(
    ~ location,
    scales = "free_x", # personal x-axis
    strip.position = "bottom", #move location names to bottom
    labeller = labeller(
      location = c(
        "Sedgwick" = "Sedgwick",
        "SCI"      = "Santa Cruz Island"
      )
    )
  ) +
 scale_color_manual(
    name = "Pit",
    values = c(
      "WML" = "darkred",
      "TAU" = "gold3",
      "GDS" = "#386641"
    )
  ) +
  scale_fill_manual(
    name = "Pit",
    values = c(
      "WML" = "darkred",
      "TAU" = "gold3",
      "GDS" = "#386641"
    )
) +
  theme_classic(base_size = 14) +
  theme(
    strip.text = element_text(face = "bold", size = 13),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank()) 




```


```{r}
#df to use for bulk density graph
#

rs_clean <- resistance |>
  mutate(depth_m = as.numeric(depth_m)) |>
  select(Rs, pit, depth_m) |>
  mutate(depth_cm = depth_m * 100) |> 
  select(-depth_m)


rs_avg <- rs_clean |>
  group_by(pit, depth_cm) |>
  summarise(mean_Rs = mean(Rs, na.rm = TRUE)) |>
  ungroup()


```

