---
title: "Rock Nitrogen"
author: "Rebecca Martinez"
date: "November 14, 2025"
output:
  pdf_document:
    toc: true
  html_document:
    toc: true
---

```{r setup, include=FALSE}
# Set global options for all chunks
knitr::opts_chunk$set(
  echo = FALSE,     # hide code
  warning = FALSE,  # hide warnings
  message = FALSE,  # hide messages
  error = FALSE     # hide errors
)

#install.packages("tidyverse")
#install.packages("gt")
#install.packages("flextable")
#intall.packages("janitor")
#install.packages("cowplot")
library(tidyverse)
library(janitor) #clean data 
library(gt)
library(flextable)
library(cowplot) # plots into objects, insert objects to make grid

```

```{r data cleaning}

# Load and clean data
rock_nitrogen <- read_csv("data_raw/rock_samples_SIF_results.csv")  |> 
  clean_names()

rock_n_full <- rock_nitrogen |> 
  mutate(across(where(is.character),
                ~ str_squish(.)  |> 
                  str_replace_all(" ", "_")  |> 
                  tolower()
                )) |> 
  mutate(
    soaked = case_when(
      str_detect(sample_id, "-p-") ~ "yes",
      str_detect(sample_id, "-n-") ~ "no",
      TRUE ~ NA
    ),
    sample_name = str_extract(sample_id, "(.*)-[pn]-", group = 1),
    location = if_else(str_detect(sample_name, "p1"), "Sedgwick", "SCI")
  ) %>%
  filter(sample_name != "ref_soil")




# Riley's N sample 

riley_rock_n <- read_csv(("data_raw/rileyh_n_data.csv"))

riley_n_clean <- riley_rock_n |> 
  rename(n_ppm = "nitrogen_ppm") |> 
  mutate(across(where(is.character), ~ str_to_lower(.)),
         location = "SCI",
         sample_name = sample_id,
         sample_name = str_replace(sample_id, "-[0-9]+$", ""))



# removing non soaked samples

n_rock_full <- rock_n_full |> 
  filter(soaked != "no") 


merged_n <- bind_rows(
  riley_n_clean |> 
    select(sample_id, rock_type, n_ppm, location, sample_name),
  n_rock_full |>  
    select(sample_id, rock_type, n_ppm, location, sample_name)
) |>   
  filter(sample_name != "sci-blue-schist") |> 
  rename(rock_labels = rock_type)


#new rock names column

lithology <- c(
  "gabbro_diorite" = "Gabbro–Diorite",
  "jolla_viejo_formation_sandstone" = "Sandstone (Tjv)",
  "jolla_viejo_formation" = "Sandstone (Tjv)",
  "older_alluvium" = "Alluvium (Qoa)",
  "vaqueros_formation_sandstone" = "Sandstone (Tvs)",
  "vaqueros_formation_conglomerate" = "Conglomerate (Tvs)",
  "monterey_formation" = "Mudstone/Shale (Tmo)",
  "tuff" = "Tuff (Ttu)",
  "cozy_dell_shale" = "Shale (Tcd)",
  "rincon_shale" = "Shale (Trn)",
  "greenstone" = "Greenstone (Jsv)",
  "serpentine" = "Serpentinite (Jsp)",
  "shale" = "Shale (Tr)",
  "sci_schist" = "Schist"
)

#rock class column
rock_class_map <- c(
  "gabbro_diorite" = "Igneous",
  "jolla_viejo_formation_sandstone" = "Sedimentary",
  "jolla_viejo_formation" = "Sedimentary",
  "older_alluvium" = "Sedimentary",
  "vaqueros_formation_sandstone" = "Sedimentary",
  "vaqueros_formation_conglomerate" = "Sedimentary",
  "monterey_formation" = "Sedimentary",
  "tuff" = "Sedimentary",
  "cozy_dell_shale" = "Sedimentary",
  "rincon_shale" = "Sedimentary",
  "greenstone" = "Metamorphic",
  "serpentine" = "Ultramafic",
  "shale" = "Sedimentary",
  "sci_schist" = "Metamorphic"
)

merged_n_full <- merged_n |> 
  mutate(
    lithology = recode(rock_labels, !!!lithology),
    rock_class = recode(rock_labels, !!!rock_class_map)
    
)


```

# Rock Nitrogen PPM from Santa Cruz Island and Sedgwick Reserves

## Summary Tables

This section summarizes nitrogen concentrations for all rock samples after cleaning the dataset.

Seperated by location:
```{r gt table}

# Create wide table: average nitrogen per sample
rock_summary_wide <- rock_n_full %>%
  mutate(
    soaked = factor(
      soaked,
      levels = c("no", "yes"),
      labels = c("Not Peroxide Soaked", "Peroxide Soaked")
    )
  ) %>%
  group_by(sample_name, soaked, location, rock_type) %>%
  summarize(
    avg_n_ppm = mean(n_ppm, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  pivot_wider(
    names_from = soaked,
    values_from = avg_n_ppm
  )


#Display table with gt

rock_summary_wide %>%
  gt(groupname_col = "location") %>%
  tab_header(title = "Average Nitrogen (ppm) per Sample") %>%
  cols_label(
    sample_name = "Sample Name",
    `Not Peroxide Soaked` = "Not Peroxide Soaked",
    `Peroxide Soaked` = "Peroxide Soaked",
    rock_type = "Rock Type"
  ) %>%
  fmt_number(
    columns = c(`Not Peroxide Soaked`, `Peroxide Soaked`),
    decimals = 2
  ) %>%
  tab_options(
    table.font.names = "Arial",
    heading.title.font.size = 16,
    table.border.top.color = "black",
    table.border.bottom.color = "black"
  )
```

Not seperated by location:

```{r flextable}
#Order table by nitrogen

rock_summary_wide_sorted <- rock_summary_wide %>%
  mutate(max_n_ppm = pmax(`Not Peroxide Soaked`, `Peroxide Soaked`, na.rm = TRUE)) %>%
  arrange(desc(max_n_ppm)) %>%
  select(-max_n_ppm)


#Create the flextable

rock_summary_wide_sorted %>%
  flextable() %>%
  set_header_labels(
    sample_name = "Sample Name",
    rock_type = "Rock Type",
    `Not Peroxide Soaked` = "Not Peroxide Soaked",
    `Peroxide Soaked` = "Peroxide Soaked",
    location = "Location"
  ) %>%
  theme_vanilla() %>%
  autofit()


```

## Visualization 1: Nitrogen by Rock Type and Treatment

This first figure compares nitrogen concentrations across rock types and shows whether each sample was peroxide-soaked.
It helps identify any treatment effects within each rock type..

```{r visual 1}

ggplot(rock_n_full, aes(x = rock_type, y = n_ppm, fill = soaked)) +
  geom_col(position = "dodge") +
  scale_fill_manual(
    values = c("yes" = "steelblue", "no" = "orange"),
    labels = c("yes" = "Peroxide Soaked", "no" = "Not Peroxide Soaked")
  ) +
  labs(
    x = "Rock Type",
    y = "Nitrogen (ppm)",
    fill = NULL
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

## Visualization 2: Nitrogen by Rock Type and Location

This plot displays nitrogen values stacked by location within each rock type.

```{r visual 2}
ggplot(rock_n_full, aes(x = rock_type, y = n_ppm, fill = location)) +
  geom_col(position = "stack") +
  labs(
    x = "Rock Type",
    y = "Nitrogen (ppm)",
    fill = "Location"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

## Visualization 3: Nitrogen by Location, Faceted by Treatment

This figure separates samples into two panels — soaked vs not soaked — while showing contributions from each location.

```{r visual 3}
ggplot(rock_n_full, aes(x = rock_type, y = n_ppm, fill = location)) +
  geom_col(position = "stack") +
  facet_wrap(~ soaked) +
  labs(
    x = "Rock Type",
    y = "Nitrogen (ppm)",
    fill = "Location"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

## Visualization 4: Nitrogen by Treatment, Faceted by Location

This flips the previous comparison.
Now each panel is a location, and bars compare soaked vs not soaked.

```{r visual 4}

ggplot(rock_n_full, aes(x = rock_type, y = n_ppm, fill = soaked)) +
  geom_col(position = "dodge") +
  facet_wrap(~ location) +
  scale_fill_manual(
    values = c("yes" = "steelblue", "no" = "orange"),
    labels = c("yes" = "Peroxide Soaked", "no" = "Not Peroxide Soaked")
  ) +
  labs(
    x = "Rock Type",
    y = "Nitrogen (ppm)",
    fill = NULL
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

  
```
Alternative:
*Under Construction*
```{r visual 4 cowplot}

# cowplot version

p <- ggplot(rock_n_full, aes(x = rock_type, y = n_ppm, fill = soaked)) +
  geom_col(position = "dodge") +
    scale_fill_manual(
    values = c("yes" = "steelblue", "no" = "orange"),
    labels = c("yes" = "Peroxide Soaked", "no" = "Not Peroxide Soaked")
  ) +
  labs(
    x = "Rock Type",
    y = "Nitrogen (ppm)",
    fill = "Pit"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

legend <- cowplot::get_legend(
  p + theme(legend.position = "bottom")
)

p_nolegend <- p + theme(legend.position = "none")

title <- cowplot::ggdraw() +
  cowplot::draw_label(
    "Nitrogen Concentrations by Rock Type",
    fontface = "bold",
    size = 16
  )

cowplot::plot_grid(
  title,
  p_nolegend,
  legend,
  ncol = 1,
  rel_heights = c(0.1, 1, 0.1)
)

```


## Visualization 5: Boxplot of Nitrogen Values

This boxplot shows the distribution of nitrogen per rock type, separated by location.

```{r visual 5}


# Boxplot of nitrogen by rock_type and soaked, faceted by location
ggplot(rock_n_full, aes(x = rock_type, y = n_ppm, fill = soaked)) +
  geom_boxplot() +
  facet_wrap(~ location) +
  labs(
    x = "Rock Type",
    y = "Nitrogen (ppm)",
    fill = NULL
  ) +
  theme_classic() +
  theme(
    panel.background = element_rect(fill = "gray95", color = "black"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

# simplified rock type with reference in parentheses:
# sandstone (Tv)
# shale (Tcd)
# sandstone (Tjv)
# 
# 
# 
# 
ggplot(merged_n, aes(x = rock_type, y = n_ppm, fill = location)) +
  geom_boxplot() +
  labs(
    x = "Rock Type",
    y = "Nitrogen (ppm)",
    fill = NULL
  ) +
  theme_classic() +
  theme(
    panel.background = element_rect(fill = "gray95", color = "black"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
#
#
```


```{r boxplot, rock N by location} 


rock_labels <- c(
  "cozy_dell_shale" = "Shale (Tcd)",
  "jolla_viejo_formation" = "Sandstone (Tjv)",
  "vaqueros_formation_sandstone" = "Sandstone (Tvs)",
  "rincon_shale" = "Shale (Tr)",
  "greenstone" = "Greenstone",
  "serpentine" = "Serpentine",
  "schist_from_conglomerate" = "Schist",
  "shale" = "Shale"
)


ggplot(merged_n, aes(x = rock_type, y = n_ppm, color = location)) +
  geom_boxplot(alpha = 0.7) +
  scale_fill_manual(
    values = c(
      "no"  = "#6A4C2A",
      "yes" = "#E8DDC8"  
    ),
    labels = c(
      "no"  = "Not Soaked",
      "yes" = "Peroxide Soaked"
         )
  ) +
  facet_wrap(~ location, scales = "free_x", labeller = labeller(location = c(
    "SCI" = "Santa Cruz Island",
    "Sedgwick" = "Sedgwick"
  ))
) +   # free x for each panel
  scale_x_discrete(labels = rock_labels) +      #simplified names
  labs(
    x = "Rock Type",
    y = "Nitrogen (ppm)",
    fill = NULL
  ) +
  theme_classic() +
  theme(
    panel.background = element_rect(color = "black"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    strip.text = element_text(face = "bold", size = 12)
  )

```



```{r}
#not seperated by soaked or not



ggplot(rock_n_full, aes(x = rock_type, y = n_ppm)) +
  geom_boxplot(fill = "#C7B8A2", outliers = FALSE) +
  facet_wrap(~ location, scales = "free_x", labeller = labeller(location = c(
    "SCI" = "Santa Cruz Island",
    "Sedgwick" = "Sedgwick"))
    ) +   # free x for each panel
  scale_x_discrete(labels = rock_labels) +      #simplified names
  labs(
    x = "Rock Type",
    y = "Nitrogen (ppm)",
    fill = NULL
  ) +
  theme_classic() +
  theme(
    panel.background = element_rect(color = "black"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    strip.text = element_text(face = "bold", size = 12)
  )



```



```{r merged N}


location_colors <- c(
  "SCI" = "#386641",      # deep green
  "Sedgwick" = "orange4"  # brown-orange
)
 
ggplot(merged_n_full, aes(x = lithology, y = n_ppm, fill =  rock_class )) +
  geom_boxplot(position = position_dodge(width = 0.7))+
  facet_wrap(~ location, scales = "free_x") +
  labs(
    x = "Lithology",
    y = "Nitrogen (ppm)",
    fill = "Location"
  ) +
  theme_bw() +
  theme(
    panel.background = element_rect(color = "black"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = c(0.2, 0.8),
    strip.text = element_text(face = "bold", size = 12)
  )

ggplot(merged_n_full, aes(x = lithology, y = n_ppm, fill = location)) +
  geom_boxplot(position = position_dodge(width = 0.7)) +
   scale_fill_manual(values = location_colors,
                    labels = c("SCI" = "Santa Cruz Island",
                               "Sedgwick" = "Sedgwick")) +
  labs(
    x = "Lithology",
    y = "Nitrogen (ppm)",
    fill = "Location") +
    theme_classic(base_size = 18)+
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = c(0.2, 0.9),
    strip.text = element_text(face = "bold", size = 12)
  )


```



*Still a work in progress...*
